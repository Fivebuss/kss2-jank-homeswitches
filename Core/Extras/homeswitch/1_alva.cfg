// Half-broken HomeWorldName-based homeswitch
// In theory this approach should be much, much better than renaming and moving things around. However, it is not without its MAJOR downsides, alongside the usual problems of homeswitches
// Set inside KSS2Settings.cfg 'homeSwitch = Alva' to use, set it to False to remove

// !!!!!!!!!! VERY IMPORTANT
// Regarding the camera displacement bug: It seems that a save and unsave inside an active game session is required. 
// If we do not do this, (Ex: Load into tracking station then out again) theres a 50/50 chance severe problems will occur. Its basically gambling
// This issue is *not* fixable by me
// !!!!!!!!!!

// Alva isnt technically habitable! But the habitable alva will be in a future KSS2 release

@Kopernicus_config:HAS[@KSS2_Settings:HAS[#homeSwitch[Alva]]]:BEFORE[KSS2]
{
    HomeWorldName = Alva // Much better than PostOrbit
    KSCLightsAlwaysOn = False
}

// We are disabling ondemand to help with the flashing orbit lines bug, and because its a switched homeworld, to attempt to curb trackingStation issues
@Kopernicus:HAS[@KSS2_Settings:HAS[#homeSwitch[Alva]]]:AFTER[KSS2]
{
    @Body[Alva]
    {
        @ScaledVersion
        {
            @Material
            {
                texture = KSS2/SystemNovaKirbani/PluginData/Alva_Color.dds
                normals = KSS2/SystemNovaKirbani/PluginData/Alva_Normal.dds
            }
            !OnDemand {}
        }
    }
}

@Kopernicus:HAS[@KSS2_Settings:HAS[#homeSwitch[Alva]]]:AFTER[KSS2]
{
    removeLaunchSites = Desert_Launch_Site,Desert_Airfield,Desert_GroundObjects,Woomerang_Launch_Site,Woomerang_GroundObjects,Island_Airfield 
    Body[Kerbin]
    {
        @PQS
        {
            !Mods[MapDecalTangent,KSC] {}
        }
        // Attempt to strip SpaceCenter node from kerbin
        !SpaceCenter {}
    }

    // Alva
    @Body[Alva]
    {
        
        PostSpawnOrbit
		{
			referenceBody = #$../../Body[Alva]/Orbit/referenceBody$ // Apparently this fixes stuff?
		}

        @Atmosphere				
		{				
			%oxygen = True	// Give alva oxygen. Yes I know, inaccurate. Oh well
		}


        @Properties
        {
            isHomeWorld = true // Help KSC scene bug
        }

        // PQS nonsense
        @PQS
        {
            @Mods
            {
                MapDecalTangent
				{
					name = KSC
					absolute = True
					absoluteOffset = 964
					angle = -90
					cullBlack = False
					DEBUG_HighlightInclusion = False
					heightMap = BUILTIN/ksc_decal_heightMap
					heightMapDeformity = 15
					removeScatter = True
					radius = 4500
                    position = 0.07497861, 0.00174533, -0.99718361

					useAlphaHeightSmoothing = True
					enabled = True
					order = 450
                }

            }
        }
        
        // Oh boy
        SpaceCenter
        {
            latitude = 0.1
            longitude = -85.7
            repositionRadiusOffset = 956
            reorientFinalAngle = -2.5            // Rotation alignment
            lodvisibleRangeMultiplier = 6
            decalLatitude = 0.1
            decalLongitude = -85.7

            // Desert sand color
            Material
            {
                grassColor = RGBA(214, 161, 98, 0.77)
            }
        }
    }
}

// Helps fix problems
@Kopernicus_config:HAS[@KSS2_Settings:HAS[#homeSwitch[Alva]]]:AFTER[KOPERNICUS]
{
    %useManualMemoryManagement = True 
}
