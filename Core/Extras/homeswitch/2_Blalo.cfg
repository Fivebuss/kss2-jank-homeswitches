// Half-broken HomeWorldName-based HomeSwitch
// In theory this approach should be much, much better than renaming and moving things around. However, it is not without its MAJOR downsides, alongside the usual problems of HomeSwitches
// Set inside KSS2Settings.cfg 'HomeSwitch = Blalo' to use, set it to False to remove

// !!!!!!!!!! VERY IMPORTANT
// Regarding the camera displacement bug: It seems that a save and unsave inside an active game session is required. 
// If we do not do this, (Ex: Load into tracking station then out again) theres a 50/50 chance severe problems will occur. Its basically gambling
// This issue is *not* fixable by me, without writing a .dll mod. I COULD maybe do that in the far future. Or kopernicus could fix it
// !!!!!!!!!!

@Kopernicus_config:HAS[@KSS2_Settings:HAS[#HomeSwitch[Blalo]]]:BEFORE[KSS2]
{
    %HomeWorldName = Blalo // Much better than PostOrbit
}

// We are disabling ondemand to fix the flashing orbit lines bug, and because its a switched homeworld, to attempt to curb trackingStation issues
@Kopernicus:HAS[@KSS2_Settings:HAS[#HomeSwitch[Blalo]]]:AFTER[KSS2]
{
    @Body[Blalo]
    {
        @ScaledVersion
        {
            @Material
            {
                texture = KSS2/SystemNovaKirbani/PluginData/Blalo_Color1.dds
                normals = KSS2/SystemNovaKirbani/PluginData/Blalo_Normal.dds
            }
            !OnDemand {}
		}
    }
}

@Kopernicus:HAS[@KSS2_Settings:HAS[#HomeSwitch[Blalo]]]:AFTER[KSS2]
{
    removeLaunchSites = Desert_Launch_Site,Desert_Airfield,Desert_GroundObjects,Woomerang_Launch_Site,Woomerang_GroundObjects,Island_Airfield 
    Body[Kerbin]
    {
        @PQS
        {
            !Mods[MapDecalTangent,KSC] {}
        }
        // Attempt to strip SpaceCenter node from kerbin
        !SpaceCenter {}
    }

    // Blalo
    @Body[Blalo]
    {
		cacheFile = KSS2/SystemNovaKirbani/_Cache/BlaloHS.bin
        @Properties
        {
            isHomeWorld = true // Help KSC scene bug
		}
		PostSpawnOrbit
		{
			referenceBody = #$../../Body[Blalo]/Orbit/referenceBody$
		}
		@Atmosphere				
		{				
			%oxygen = True	
		}

        // PQS nonsense, part 2
        @PQS
        {
            @Mods
            {
                MapDecalTangent
				{
					name = KSC
					absolute = True
					absoluteOffset = 602 // -8 from KSC altitude
					angle = 133
					cullBlack = False
					DEBUG_HighlightInclusion = False
					heightMap = BUILTIN/ksc_decal_heightMap
					heightMapDeformity = 15 // 15 works best for KSC
					removeScatter = False
					radius = 3100 // Radius of decal. Yet its a square. What?
                    position = -389974.5,5114.8418,343938.563 // OFfset to have KSC centered

					useAlphaHeightSmoothing = True
					enabled = True
					order = 450
                }

                // Parallax mask
                // Derived from xolem.cfg
                !MapDecalVertexRemoveScatter:HAS[#name[ParallaxMaskKSC]]
                MapDecalVertexRemoveScatter
                {
                    name = ParallaxMaskKSC
                    colorMap = KSS2/Core/Extras/HomeSwitch/KSCD.dds
                    debugColorMap = KSS2/Core/Extras/HomeSwitch/KSCD.dds
                    angle = -133 // Flip as the DDS file is flipped too
                    radius = 1650 // Same thing
                    position = -0.74888831, 0.00982839, 0.66222880 // Offset

                    
                    BlockedScatters
                    {
                        // WHY DOES BLALO HAVE SO MANY AAAAAAAA
                        name = SlabsSmall
                        name = SlabsMed
                        name = SlabsLarge
                        name = SmallRocksVar1
                        name = SmallRocksVar2
                        name = MedRocksVar1
                        name = MedRocksVar2
                        name = MedRocksVar3
                        name = DesertRocks
                        name = SteepRocksMed
                        name = SteepRocksSmall
                        name = PileSmall
                        name = PileLarge
                        name = Boulder
                        name = RockSpikeSmall
                        name = RockSpikeLarge
                        name = KerbinGrass
                        name = KerbinGrassTall
                        name = KerbinDryGrass
                        name = BlaloWaterPlant
                        name = BlaloWaterSpike
                        name = Seaweed
                        name = Seagrass
                        name = BlaloTree
                        name = BlaloFrame
                        name = DesertStructure
                        name = Rock_05
                        name = Rock_06
                        name = Rock_16
                        // WHY DOES BLALO HAVE SO MANY AAAAAAAA

                    }
                    

                    debugShowDecal = False
                    debugShowDecal = False
                    order = 99999
                }

            }
        }
		
        // Oh boy
        SpaceCenter
        {
            // Positioned overlooking a nice area near equator
            latitude = 0.563583804409907
			longitude = 138.529271920431
			decalLatitude = 0.563583804409907
			decalLongitude = 138.589271920431
            repositionRadiusOffset = 594 // Decal difference is +8
            reorientFinalAngle = 133           // Rotation aligned to 90deg
            lodvisibleRangeMult = 6

            // Blalo grass color #A6945A
            Material
            {
                grassColor = RGBA(166, 148, 90, 1)
            }
        }
    }
}

// Helps fix problems
@Kopernicus_config:HAS[@KSS2_Settings:HAS[#HomeSwitch[Blalo]]]:AFTER[KOPERNICUS]
{
    %useManualMemoryManagement = True 
}